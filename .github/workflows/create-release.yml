name: Create Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(TZ=Asia/Tokyo date '+%Y.%m.%d')
          BASE_TAG="v${DATE}"

          EXISTING_TAGS=$(git tag -l "${BASE_TAG}*" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            NEW_TAG="${BASE_TAG}"
          else
            LAST_TAG=$(echo "$EXISTING_TAGS" | tail -1)
            if [ "$LAST_TAG" = "$BASE_TAG" ]; then
              NEW_TAG="${BASE_TAG}.2"
            else
              LAST_NUM=$(echo "$LAST_TAG" | grep -oE '[0-9]+$')
              NEXT_NUM=$((LAST_NUM + 1))
              NEW_TAG="${BASE_TAG}.${NEXT_NUM}"
            fi
          fi

          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log "${PREV_TAG}..HEAD" --oneline --no-merges --format="- %s (%h)")
          else
            COMMITS=$(git log --oneline --no-merges --format="- %s (%h)" -20)
          fi

          COMMIT_COUNT=$(echo "$COMMITS" | wc -l | tr -d ' ')

          BODY=$(cat <<EOF
          ## 変更内容 (${COMMIT_COUNT}件)

          ${COMMITS}

          ---
          *このリリースは GitHub Actions によって自動生成されました。*
          EOF
          )
          BODY=$(echo "$BODY" | sed 's/^          //')

          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

          gh release create "$NEW_TAG" \
            --title "Release ${NEW_TAG}" \
            --notes "$BODY" \
            --latest
